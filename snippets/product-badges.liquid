{%- liquid
  assign theme_st = settings
  assign show_sale = theme_st.show_sale
  assign sale_color = theme_st.sale_color
  assign sale_background = theme_st.sale_background
  assign sale_format = theme_st.sale_format
  assign show_new = theme_st.show_new
  assign new_color = theme_st.new_color
  assign new_background = theme_st.new_background
  assign new_badge_display_period = theme_st.new_badge_display_period
  assign show_pre_order = theme_st.show_pre_order
  assign pre_order_color = theme_st.pre_order_color
  assign pre_order_background = theme_st.pre_order_background
  assign show_sold_out = theme_st.show_sold_out
  assign sold_out_color = theme_st.sold_out_color
  assign sold_out_background = theme_st.sold_out_background
  assign custom_badge_color = theme_st.custom_badge_color
  assign custom_badge_background = theme_st.custom_badge_background

  if card_product and card_product != empty
    assign option_name = 'Color'
    assign sale = false
    assign sold_out = false
    assign pre_order = false
    assign product_avail = false
    assign product_qty = 0
    if card_product.has_only_default_variant == false
      if card_product.options_with_values[0].name == option_name
        if card_product.options_with_values.size < 2
          for variant in card_product.variants limit: 1
            assign product_qty = product_qty | plus: variant.inventory_quantity
            assign product_avail = variant.available
            assign product_management = variant.inventory_management
            assign compare_at_price = variant.compare_at_price
            assign price = variant.price
          endfor
          if product_management != null
            if product_qty < 1
              if product_avail == true
                assign pre_order = true
                assign sold_out = false
              else
                assign pre_order = false
                assign sold_out = true
              endif
            else
              assign pre_order = false
              assign sold_out = false
            endif
          else
            assign pre_order = false
            assign sold_out = false
          endif
        else
          assign prod = card_product.variants | where: 'option1', card_product.options_with_values[0].values[0]
          assign product_management = 'shopify'
          for p in prod
            assign product_qty = product_qty | plus: p.inventory_quantity
            if p.available
              assign product_avail = true
            endif
            if p.inventory_management == null
              assign product_management = 'null'
            endif
            assign compare_at_price = prod[0].compare_at_price
            assign price = prod[0].price
            if product_management != 'null'
              if product_qty < 1
                if product_avail == true
                  assign pre_order = true
                  assign sold_out = false
                else
                  assign pre_order = false
                  assign sold_out = true
                endif
              else
                assign pre_order = false
                assign sold_out = false
              endif
            else
              assign pre_order = false
              assign sold_out = false
            endif
          endfor
        endif
      else
        assign product_management = 'shopify'
        for variant in card_product.variants
          assign product_qty = product_qty | plus: variant.inventory_quantity
          if variant.available == true
            assign product_avail = true
          endif
          if variant.inventory_management == null
            assign product_management = 'null'
          endif
        endfor
        assign compare_at_price = card_product.variants[0].compare_at_price
        assign price = card_product.variants[0].price
        if product_management != 'null'
          if product_qty < 1
            if product_avail == true
              assign pre_order = true
              assign sold_out = false
            else
              assign pre_order = false
              assign sold_out = true
            endif
          else
            assign pre_order = false
            assign sold_out = false
          endif
        else
          assign pre_order = false
          assign sold_out = false
        endif
      endif
    else
      assign compare_at_price = card_product.compare_at_price
      assign price = card_product.price
      if card_product.available != true
        assign sold_out = true
      endif
      for v in card_product.variants
        if v.inventory_quantity
          assign product_qty = product_qty | plus: v.inventory_quantity
        endif
      endfor
      if product_qty < 1 and card_product.available == true
        assign pre_order = true
        assign sold_out = false
      endif
      for v in card_product.variants
        if v.inventory_management == null
          assign pre_order = false
          assign sold_out = false
        endif
      endfor
    endif
    if compare_at_price > price and compare_at_price != blank
      assign sale = true
    endif
  endif

  assign product_create_at = card_product.created_at | date: '%s'
  assign now_timestamp = 'now' | date: '%s'
  assign diff_seconds = now_timestamp | minus: product_create_at
  assign diff_days = diff_seconds | divided_by: 3600 | divided_by: 24
-%}
{%- if sale or sold_out or pre_order or show_new or card_product.metafields.custom.custom_product_badge -%}
  <div
    class="product__badges"
    data-pre-order-color="{{ pre_order_color }}"
    data-pre-order-background="{{ pre_order_background }}"
    data-sale-color="{{ sale_color }}"
    data-sale-background="{{ sale_background }}"
    data-sold-out-color="{{ sold_out_color }}"
    data-sold-out-background="{{ sold_out_background }}"
  >
    {%- if card_product.metafields.custom.external_affiliate != blank -%}
      <div class="product__badges">
        <div class="product__badges-external">
          {{ card_product.metafields.custom.external_affiliate.value.button_text }}
        </div>
      </div>
    {%- else -%}
      {%- if sale and show_sale -%}
        <div class="product__badges-sale">
          {%- assign p = compare_at_price | minus: price -%}
          {%- if sale_format == 'text' -%}
            {{ 'products.product.sale_text' | t }}
          {%- elsif sale_format == 'fixed' -%}
            {{ 'products.product.save' | t }}
            {{- p | money -}}
          {%- else -%}
            {%- if p > 0 -%}
              {%- assign p = p | times: 100.0 | divided_by: compare_at_price | round -%}
            {%- endif -%}
            {{ 'products.product.sale' | t: discount: p }}
          {%- endif -%}
        </div>
      {%- endif -%}
      {%- if sold_out and show_sold_out -%}
        <div class="product__badges-sold-out">
          {{ 'products.product.sold_out' | t }}
        </div>
      {%- else -%}
        {%- if pre_order and show_pre_order -%}
          <div class=" product__badges-pre-order">
            {{ 'products.product.pre_order' | t }}
          </div>
        {%- endif -%}
      {%- endif -%}
      {%- if show_new and diff_days < new_badge_display_period -%}
        <div class="product__badges-new">
          {{ 'products.product.new_label' | t }}
        </div>
      {%- endif -%}
      {%- if card_product.metafields.custom.custom_product_badge -%}
        <div class="product__badges-customr">
          {{ card_product.metafields.custom.custom_product_badge }}
        </div>
      {%- endif -%}
    {%- endif -%}
  </div>
{%- endif -%}
