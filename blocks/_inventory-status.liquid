{%- liquid
  assign product = closest.product
  assign inventory_base = block.settings.inventory_base
  assign inventory_threshold = block.settings.inventory_threshold
-%}
{% if product.metafields.custom.external_affiliate == blank %}
  <div class="main-product-block inventory_status">
    {%- liquid
      assign product_qty = product.selected_or_first_available_variant.inventory_quantity
      assign product_management = product.selected_or_first_available_variant.inventory_management
      assign product_available = product.selected_or_first_available_variant.available
    -%}
    <inventory-progress-bar
      data-order="{{ product_qty }}"
      data-available="{{ product_available }}"
      data-fe-amount="{{ inventory_base }}"
      data-threshold="{{ inventory_threshold }}"
      class="{% if product_qty <= inventory_threshold %} notify{% endif %}{% if product_management != "shopify" %} d-none{% else %} block{%- endif -%}"
    >
      <div class="progress-bar-message heading_weight">
        <div class="message">
          {%- if product_qty <= inventory_threshold -%}
            {%- if product_qty > 0 -%}
              {{ 'products.product.inventory_status.low_stock' | t: count: product_qty }}
            {%- else -%}
              {%- if product_available -%}
                {{ 'products.product.inventory_status.pre_order' | t }}
              {%- else -%}
                {{ 'products.product.inventory_status.sold_out' | t }}
              {%- endif -%}
            {%- endif -%}
          {%- else -%}
            {{ 'products.product.inventory_status.available' | t }}
          {%- endif -%}
        </div>
      </div>
      <div
        class="progress-bar h-custom rounded-10 mt-10 bg-custom"
        style="--custom-height: 6px; --bg-custom: #E5E5E5;"
      >
        <div class="progress absolute left-0 inset-y-0" style="width: 100%;"></div>
      </div>
    </inventory-progress-bar>
    {%- if product.selected_or_first_available_variant.incoming -%}
      <div class="incoming-message">
        {%- if product.selected_or_first_available_variant.next_incoming_date != blank -%}
          {%- assign date_convert = product.selected_or_first_available_variant.next_incoming_date
            | date: '%B %d, %Y'
          -%}
          {{ 'products.product.inventory_status.incoming_with_date' | t: date: date_convert }}
        {%- else -%}
          {{ 'products.product.inventory_status.incoming' | t }}
        {%- endif -%}
      </div>
    {%- endif -%}
  </div>
{% endif %}
{% schema %}
{
  "name": "t:sections.all.product_setting.inventory_status.name",
  "class": "block-product__inventory mb-25",
  "settings": [
    {
      "type": "range",
      "id": "inventory_threshold",
      "min": 1,
      "max": 20,
      "step": 1,
      "default": 20,
      "label": "t:sections.all.product_setting.inventory_status.settings.inventory_threshold.label",
      "info": "t:sections.all.product_setting.inventory_status.settings.inventory_threshold.info"
    },
    {
      "type": "number",
      "id": "inventory_base",
      "default": 50,
      "label": "t:sections.all.product_setting.inventory_status.settings.inventory_base.label",
      "info": "t:sections.all.product_setting.inventory_status.settings.inventory_base.info"
    }
  ],
  "presets": [{ "name": "t:sections.all.product_setting.inventory_status.name" }]
}
{% endschema %}
