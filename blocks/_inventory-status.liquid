{%- liquid
  assign product = closest.product
  assign inventory_base = block.settings.inventory_base
  assign inventory_threshold = block.settings.inventory_threshold
-%}
{% if product.metafields.custom.external_affiliate == blank %}
  <div class="main-product-block inventory_status">
    {%- liquid
      assign product_qty = product.selected_or_first_available_variant.inventory_quantity
      assign product_management = product.selected_or_first_available_variant.inventory_management
      assign product_available = product.selected_or_first_available_variant.available
    -%}
    <inventory-progress-bar
      data-order="{{ product_qty }}"
      data-available="{{ product_available }}"
      data-fe-amount="{{ inventory_base }}"
      data-threshold="{{ inventory_threshold }}"
      class="{% if product_qty <= inventory_threshold %} notify{% endif %}{% if product_management != "shopify" %} d-none{% else %} block{%- endif -%}"
    >
      <div class="progress-bar-message">
        {%- if product_qty <= inventory_threshold -%}
          {%- if product_qty > 0 -%}
            <div class="message flex gap-10 sale-color">
              <svg width="27" height="24" viewBox="0 0 27 24" fill="none" class="low_stock-icon">
                <path d="M12.4102 14.6808C12.4102 15.194 11.9941 15.6101 11.4808 15.6101H0.929397C0.416105 15.6101 0 15.194 0 14.6808C0 14.1675 0.416105 13.7514 0.929397 13.7514H11.4808C11.9941 13.7514 12.4102 14.1675 12.4102 14.6808ZM11.4808 17.4689H3.71759C3.2043 17.4689 2.78819 17.8851 2.78819 18.3983C2.78819 18.9116 3.2043 19.3277 3.71759 19.3277H11.4808C11.9941 19.3277 12.4102 18.9116 12.4102 18.3983C12.4102 17.8851 11.9941 17.4689 11.4808 17.4689ZM11.4808 21.1865H6.50578C5.99249 21.1865 5.57638 21.6026 5.57638 22.1159C5.57638 22.6292 5.99249 23.0453 6.50578 23.0453H11.4808C11.9941 23.0453 12.4102 22.6292 12.4102 22.1159C12.4102 21.6026 11.9941 21.1865 11.4808 21.1865ZM16.4066 14.4335L20.1447 10.7001C20.5013 10.3309 20.491 9.74256 20.1218 9.38598C19.7617 9.03814 19.1907 9.03814 18.8305 9.38598L15.0943 13.1166C14.7251 13.4732 14.7149 14.0615 15.0715 14.4307C15.4281 14.8 16.0164 14.8102 16.3856 14.4536C16.3934 14.4461 16.401 14.4385 16.4085 14.4307L16.4066 14.4335ZM16.679 3.59305V1.85879H17.5582C18.0715 1.85879 18.4876 1.44269 18.4876 0.929397C18.4876 0.416106 18.0715 0 17.5582 0H13.9428C13.4295 0 13.0134 0.416105 13.0134 0.929397C13.0134 1.44269 13.4295 1.85879 13.9428 1.85879H14.822V3.59119C12.6684 3.78152 10.6312 4.65187 9.00493 6.0764L7.7837 4.85517C7.4208 4.49176 6.83201 4.49134 6.4686 4.85424C6.10519 5.21714 6.10478 5.80593 6.46767 6.16934L7.72793 7.42867C6.96004 8.39956 6.37465 9.5017 6.00019 10.6816C5.86037 11.1754 6.1474 11.6892 6.64129 11.829C7.11507 11.9631 7.61123 11.7044 7.77255 11.2392C8.86575 7.75859 12.0957 5.39362 15.744 5.40258H15.7514H15.7589C20.381 5.40412 24.1268 9.1524 24.1253 13.7746C24.1237 18.3968 20.3755 22.1426 15.7533 22.141C15.5916 22.141 15.4289 22.1327 15.2412 22.1234C14.733 22.1055 14.3048 22.4993 14.2802 23.0072C14.2613 23.5226 14.6609 23.9571 15.1761 23.9812C15.3685 23.9905 15.5618 23.9998 15.7533 23.9998C21.3994 24.0332 26.0035 19.4832 26.0369 13.837C26.0684 8.50457 21.9959 4.04353 16.6827 3.59026L16.679 3.59305Z" fill="currentColor"/>
              </svg>
              {{ 'products.product.inventory_status.low_stock' | t: count: product_qty }}
            </div>
          {%- else -%}
            {%- if product_available -%}
              {{ 'products.product.inventory_status.pre_order' | t }}
            {%- else -%}
              {{ 'products.product.inventory_status.sold_out' | t }}
            {%- endif -%}
          {%- endif -%}
        {%- else -%}
          {{ 'products.product.inventory_status.available' | t }}
        {%- endif -%}
      </div>
      <div
        class="progress-bar h-custom rounded-10 mt-10 bg-custom relative"
        style="--height: 6px; --bg-color-custom: #E5E5E5;"
      >
        <div class="bg-sale transition rounded-10 progress absolute left-0 inset-y-0" style="width: 100%;"></div>
      </div>
    </inventory-progress-bar>
    {%- if product.selected_or_first_available_variant.incoming -%}
      <div class="incoming-message">
        {%- if product.selected_or_first_available_variant.next_incoming_date != blank -%}
          {%- assign date_convert = product.selected_or_first_available_variant.next_incoming_date
            | date: '%B %d, %Y'
          -%}
          {{ 'products.product.inventory_status.incoming_with_date' | t: date: date_convert }}
        {%- else -%}
          {{ 'products.product.inventory_status.incoming' | t }}
        {%- endif -%}
      </div>
    {%- endif -%}
  </div>
{% endif %}
{% schema %}
{
  "name": "t:sections.all.product_setting.inventory_status.name",
  "class": "block-product__inventory mb-25 slideIn-animate",
  "settings": [
    {
      "type": "range",
      "id": "inventory_threshold",
      "min": 1,
      "max": 20,
      "step": 1,
      "default": 20,
      "label": "t:sections.all.product_setting.inventory_status.settings.inventory_threshold.label",
      "info": "t:sections.all.product_setting.inventory_status.settings.inventory_threshold.info"
    },
    {
      "type": "number",
      "id": "inventory_base",
      "default": 50,
      "label": "t:sections.all.product_setting.inventory_status.settings.inventory_base.label",
      "info": "t:sections.all.product_setting.inventory_status.settings.inventory_base.info"
    }
  ],
  "presets": [{ "name": "t:sections.all.product_setting.inventory_status.name" }]
}
{% endschema %}
